<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <title>Force-Directed Layout</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.js"></script>
    <style>
      body, html{
        margin: 0;
        padding: 0;
        font-family: helvetica, arial, "sans-serif";
        font-size: 1em;
      }
      .column-label { 
        text-anchor: middle;
        fill: black;
        font-size: 1em;
      }
      .row-label { 
        text-anchor: middle;
        fill: black;
        font-size: 1em;
      }
      h1{
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1> Simpsons Paradox </h1>
    <script type="text/javascript">

var w = window.innerWidth
  , h = window.innerHeight - 100
  , data = {
    'Derek Jeter' : {
      '1995' : [12, 48]
      , '1996' : [183, 582]
      , 'combined' : [195, 630]
    }
    , 'David Justice' : {
      '1995' : [104, 411]
      , '1996' : [45, 140]
      , 'combined' : [149, 551]
    }
  }
  , fill = d3.scale.category10()
  , foci
  , links
  , cols = Object.keys(data[Object.keys(data)[0]])
  , rows = Object.keys(data)
  , svg = d3.select('body').append('svg')
      .attr('width', w)
      .attr('height', h)
  , force = d3.layout.force()
    .nodes([])
    .links([])
    .gravity(0)
    .size([w, h])
    .linkDistance(0)
    .linkStrength(2)
    .friction(0.1)
    .charge(function(d, i){ return d.charge })
  , fociLinks = function(nodes, foci){
    return nodes.map(function(node){
      return { source : node, target : foci }
    })
  }
  , createNodes = function(num, denom, name){
    return d3.range(denom).map(function(d){
      return { 
        id : d < num ? 0 : 1
        , x : d < num ? 0 : w
        , y : Math.random() * h
        , charge : -100
        , name : name
      }
    })
  }
  , createFoci = function(x, y, name){
    return { x : x, y : y, charge : 0, fixed : true, name : name }
  }

// create all the focal points for the different nodes
var focis = {}
var foci_arr = []
d3.range(6).map(function(d){
  var col = (d % 3)
    , row = ~~(d / 3)
    , row_class = rows[row].replace(' ', '').toLowerCase()
    , x = (col + 1) * w / 4
    , y = (row + 1) * h / 3
    , foci1 = createFoci( x,  y, row_class + '-' + cols[col] + ' foci foci-0')
    , foci2 = createFoci( x,  y, row_class + '-' + cols[col] + ' foci foci-1')
  if(!focis[rows[row]]) focis[rows[row]] = {}
  focis[rows[row]][cols[col]] = [foci1, foci2]
  force.nodes().push(foci1)
  force.nodes().push(foci2)
  foci_arr.push(foci1,foci2)
})


rows.forEach(function(row){
  cols.slice(0, -1).forEach(function(col){
    var num = data[row][col][0]
      , den = data[row][col][1]
    nodes = createNodes(num, den, row + '-' + col)
    force.nodes().push.apply(force.nodes(), nodes)
    force.links().push.apply(force.links(), fociLinks(nodes.filter(function(d){ 
      return d.id === 0 
    }), focis[row][col][0] ))
    force.links().push.apply(force.links(), fociLinks(nodes.filter(function(d){ 
      return d.id === 1
    }), focis[row][col][1] ))
  })
})

force.on('tick', function(e){
  svg.selectAll('circle.node')
    .attr('cx', function(d) { return d.x })
    .attr('cy', function(d) { return d.y })
})

svg.selectAll('circle' + '.node')
  .data(force.nodes())
  .enter().append('circle')
    .attr('class', function(d){ return 'node ' + d.name})
    .attr('cx', function(d) { return d.x })
    .attr('cy', function(d) { return d.y })
    .attr('r', 2)
    .style('fill', function(d) { return fill(d.id) })
    .style('stroke', function(d) { return d3.rgb(fill(d.id)).darker(2) })
    .style('stroke-width', 1)

force.start()

d3.select('.foci')
  .transition()
  .attr('cx', function(d){
    console.log(d)
    return 0
  })


// setTimeout(function(){
//   moveFoci(focis[rows[0]][cols[0]][1], { x : w / 4 * 2 })
//   moveFoci(focis[rows[0]][cols[1]][0], { x : w / 4 * 1 })
//   moveFoci(focis[rows[1]][cols[0]][1], { x : w / 4 * 2 })
//   moveFoci(focis[rows[1]][cols[1]][0], { x : w / 4 * 1 })
//   setTimeout(function(){
//     for(var row in rows){
//       for(var col in cols){
//         moveFoci(focis[rows[row]][cols[col]][0], { x : w / 4 * 3 })
//         moveFoci(focis[rows[row]][cols[col]][1], { x : w / 4 * 3 })
//       }
//     }
//   }, 1000)
// }, 5000)


function moveFoci(foci, pos){
  if(!pos.x) pos.x = foci.x
  if(!pos.y) pos.y = foci.y
  foci.px = foci.x = pos.x
  foci.py = foci.y = pos.y
  force.start()
}

// Labels

// todo: change root `em` size depending on window size
d3.select('body').style('font-size', '1em')

// column headers
svg.selectAll('text.column-label')
  .data(cols)
  .enter().append('text')
    .attr({
      x : function(d, i){ return w / 4 * i + w / 4 }
      , y : 20
      , anchor : 'middle'
      , class : 'column-label'
    }).text(function(d){ return d})

svg.selectAll('text.row-label')
  .data(rows)
  .enter().append('text')
    .attr({
      x : 100
      , y : function(d, i){ return h / 3 * i + h / 3 }
      , anchor : 'right'
      , class : 'row-label'
    }).text(function(d){ return d})

    </script>
  </body>
</html>