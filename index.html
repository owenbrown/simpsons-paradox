<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <title>Force-Directed Layout</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.js"></script>
    <style>
      body, html{
        margin: 0;
        padding: 0;
        font-family: helvetica, arial, "sans-serif";
        font-size: 1em;
      }
      .column-label { 
        text-anchor: middle;
        fill: black;
        font-size: 1em;
      }
      .row-label { 
        text-anchor: middle;
        fill: black;
        font-size: 1em;
      }
      .foci{
        /* uncomment out to show foci for debugging */
        display: none;
      }
      h1{
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1> Simpsons Paradox </h1>
    <script type="text/javascript">

var w = window.innerWidth
  , h = window.innerHeight - 100
  , data = {
    'Derek Jeter' : {
      '1995' : [12, 48]
      , '1996' : [183, 582]
      , 'combined' : [195, 630]
    }
    , 'David Justice' : {
      '1995' : [104, 411]
      , '1996' : [45, 140]
      , 'combined' : [149, 551]
    }
  }
  , fill = function(d){
    if(d) return 'black'
    else return 'steelblue'
  }
  , foci
  , links
  , duration = 4000
  , cols = Object.keys(data[Object.keys(data)[0]])
  , rows = Object.keys(data)
  , svg = d3.select('body').append('svg')
      .attr('width', w)
      .attr('height', h)
  , createForce = function(){
    return d3.layout.force()
      .nodes([])
      .links([])
      .gravity(0)
      .size([w, h])
      .linkDistance(0)
      .linkStrength(2)
      .friction(0.1)
      .charge(function(d, i){ return d.charge })
  }
  , force1 = createForce()
  , force2 = createForce()
  , force = createForce()
  , fociLinks = function(nodes, foci){
    return nodes.map(function(node){
      return { source : node, target : foci }
    })
  }
  , createNodes = function(num, denom, name){
    return d3.range(denom).map(function(d){
      return { 
        id : d < num ? 0 : 1
        , x : d < num ? 0 : w
        , y : Math.random() * h
        , charge : -100
        , name : name
      }
    })
  }
  , createFoci = function(x, y, name){
    return { x : x, y : y, charge : 0, fixed : true, name : name }
  }
  , focis = {}
  , rowClass = function(row){ return rows[row].replace(' ', '').toLowerCase() }
  

// create all the focal points for the different nodes
d3.range(6).map(function(d){
  var col = (d % 3)
    , row = ~~(d / 3)
    , row_class = rowClass(row)
    , x = (col + 1) * w / 4
    , y = (row + 1) * h / 3
    , foci1 = createFoci( x,  y, row_class + '-' + cols[col] + ' foci foci-0')
    , foci2 = createFoci( x,  y, row_class + '-' + cols[col] + ' foci foci-1')
  if(!focis[rows[row]]) focis[rows[row]] = {}
  focis[rows[row]][cols[col]] = [foci1, foci2]
  force.nodes().push(foci1)
  force.nodes().push(foci2)
})


rows.forEach(function(row){
  cols.slice(0, -1).forEach(function(col){
    var num = data[row][col][0]
      , den = data[row][col][1]
    nodes = createNodes(num, den, row + '-' + col)
    force.nodes().push.apply(force.nodes(), nodes)
    force.links().push.apply(force.links(), fociLinks(nodes.filter(function(d){ 
      return d.id === 0 
    }), focis[row][col][0] ))
    force.links().push.apply(force.links(), fociLinks(nodes.filter(function(d){ 
      return d.id === 1
    }), focis[row][col][1] ))
  })
})

force.on('tick', function(e){
  svg.selectAll('circle.node')
    .attr('cx', function(d) { return d.x })
    .attr('cy', function(d) { return d.y })
})

svg.selectAll('circle' + '.node')
  .data(force.nodes())
  .enter().append('circle')
    .attr('class', function(d){ return 'node ' + d.name})
    .attr('cx', function(d) { return d.x })
    .attr('cy', function(d) { return d.y })
    .attr('r', 2)
    .style('fill', function(d) { return fill(d.id) })
    .style('stroke', function(d) { return d3.rgb(fill(d.id)).darker(2) })
    .style('stroke-width', 1)

force.start()


var loop = function(){
  setTimeout(function(){
    setTimeout(function(){
      for(var row in rows){
        cols.slice(0, -1).forEach(function(d, i){
          animFoci('.' + rowClass(row) + '-' + d + '.foci-0', { x : w / 4 * 1 }, duration)
          animFoci('.' + rowClass(row) + '-' + d + '.foci-1', { x : w / 4 * 2 }, duration)
        })
      }
      setTimeout(function(){
        for(var row in rows){
          cols.slice(0, -1).forEach(function(d, i){
            animFoci('.' + rowClass(row) + '-' + d, { x : w / 4 * 3 }, duration)
          })
        }
        setTimeout(function(){
          setTimeout(function(){
            for(var row in rows){
              cols.slice(0, -1).forEach(function(d, i){
                animFoci('.' + rowClass(row) + '-' + d + '.foci-0', { x : w / 4 * 1 }, duration)
                animFoci('.' + rowClass(row) + '-' + d + '.foci-1', { x : w / 4 * 2 }, duration)
              })
            }
            setTimeout(function(){
              for(var row in rows){
                cols.slice(0, -1).forEach(function(d, i){
                  animFoci('.' + rowClass(row) + '-' + d + '.foci-0', { x : w / 4 * (1 + i) }, duration)
                  animFoci('.' + rowClass(row) + '-' + d + '.foci-1', { x : w / 4 * (1 + i) }, duration)
                })
              }
              loop()
            }, duration)
          }, duration)
        }, duration)
      }, duration)
    }, duration)
  }, duration)
}

loop()

function animFoci(foci, pos, duration){
  if(duration === undefined) duration = 1000
  d3.selectAll(foci)
    .transition()
    .duration(duration)
    .ease("cubic")
    .tween('dataTweet', function(d){
      if(!pos.x) pos.x = d.x
      if(!pos.y) pos.y = d.y
      var ix = d3.interpolate(d.x, pos.x)
      var iy = d3.interpolate(d.y, pos.y)
      return function(t){
        d.x = d.px = ix(t)
        d.y = d.py = iy(t)
      }
    })
  force.start()
}

// Labels

// todo: change root `em` size depending on window size
d3.select('body').style('font-size', '1em')

// column headers
svg.selectAll('text.column-label')
  .data(cols)
  .enter().append('text')
    .attr({
      x : function(d, i){ return w / 4 * i + w / 4 }
      , y : 20
      , anchor : 'middle'
      , class : 'column-label'
    }).text(function(d){ return d})

svg.selectAll('text.row-label')
  .data(rows)
  .enter().append('text')
    .attr({
      x : 100
      , y : function(d, i){ return h / 3 * i + h / 3 }
      , anchor : 'right'
      , class : 'row-label'
    }).text(function(d){ return d})

    </script>
  </body>
</html>